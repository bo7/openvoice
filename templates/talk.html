<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS - OpenVoice</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #00d4ff; }
        a { color: #00d4ff; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 15px; }
        
        .engine-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .engine-tab { padding: 10px 20px; border: 2px solid #333; background: #252540; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .engine-tab:hover { border-color: #00d4ff; }
        .engine-tab.active { background: #00d4ff; color: #1a1a2e; border-color: #00d4ff; }
        .engine-tab small { display: block; font-size: 0.7em; opacity: 0.8; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #333; border-radius: 8px; background: #252540; color: #eee; font-size: 16px; resize: vertical; }
        select, input[type="range"] { width: 100%; padding: 10px; border: 1px solid #333; border-radius: 8px; background: #252540; color: #eee; }
        
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }
        
        .params { background: #252540; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .params.visible { display: block; }
        .params h4 { margin-top: 0; color: #00d4ff; }
        
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .slider-row label { width: 120px; margin: 0; }
        .slider-row input { flex: 1; }
        .slider-row span { width: 50px; text-align: right; }
        
        button { background: #00d4ff; color: #1a1a2e; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #00b8e6; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .error { background: #ff4444; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .success { background: #44ff44; color: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        audio { width: 100%; margin-top: 15px; }
        .audio-box { background: #252540; padding: 20px; border-radius: 8px; margin-top: 20px; }
        
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .status-dot.online { background: #44ff44; }
        .status-dot.offline { background: #ff4444; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">Home</a>
        <a href="/talk">Sprechen</a>
        <a href="/voiceClone">Stimme klonen</a>
    </div>
    
    <h1>Text-to-Speech</h1>
    
    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}
    
    <form method="POST" id="ttsForm">
        <!-- Engine Tabs -->
        <div class="engine-tabs">
            {% for key, srv in servers.items() %}
            <div class="engine-tab {% if selected_engine == key or (not selected_engine and key == 'xtts') %}active{% endif %}" 
                 data-engine="{{ key }}" onclick="selectEngine('{{ key }}')">
                <span id="status-{{ key }}" class="status-dot"></span>
                <strong>{{ srv.name }}</strong>
                <small>{{ srv.desc }}</small>
            </div>
            {% endfor %}
        </div>
        <input type="hidden" name="engine" id="engineInput" value="{{ selected_engine or 'xtts' }}">
        
        <div class="form-group">
            <label>Text</label>
            <textarea name="text" placeholder="Text eingeben...">{{ text or '' }}</textarea>
        </div>
        
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>Stimme</label>
                    <select name="voice" id="voiceSelect">
                        {% for engine, voice_list in voices.items() %}
                        <optgroup label="{{ servers[engine].name }}" data-engine="{{ engine }}">
                            {% for v in voice_list %}
                            <option value="{{ v }}" {% if selected_voice == v %}selected{% endif %}>{{ v }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>Sprache</label>
                    <select name="language">
                        {% for code, name in languages.items() %}
                        <option value="{{ code }}" {% if selected_language == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Chatterbox Params -->
        <div class="params" id="chatterbox-params">
            <h4>Chatterbox Parameter</h4>
            <div class="form-group">
                <label>Preset</label>
                <select name="preset" id="presetSelect" onchange="applyPreset()">
                    {% for key, p in presets.items() %}
                    <option value="{{ key }}" {% if selected_preset == key %}selected{% endif %}>{{ p.label }}</option>
                    {% endfor %}
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="slider-row">
                <label>Exaggeration</label>
                <input type="range" name="exaggeration" id="exaggeration" min="0" max="2" step="0.1" value="{{ exaggeration or 0.5 }}" oninput="updateSlider(this)">
                <span id="exaggeration-val">{{ exaggeration or 0.5 }}</span>
            </div>
            <div class="slider-row">
                <label>CFG Weight</label>
                <input type="range" name="cfg_weight" id="cfg_weight" min="0" max="1" step="0.1" value="{{ cfg_weight or 0.5 }}" oninput="updateSlider(this)">
                <span id="cfg_weight-val">{{ cfg_weight or 0.5 }}</span>
            </div>
            <div class="slider-row">
                <label>Temperature</label>
                <input type="range" name="temperature" id="temperature" min="0.1" max="1.5" step="0.1" value="{{ temperature or 0.8 }}" oninput="updateSlider(this)">
                <span id="temperature-val">{{ temperature or 0.8 }}</span>
            </div>
        </div>
        
        <!-- MLX Params -->
        <div class="params" id="mlx-params">
            <h4>MLX-Audio Parameter</h4>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Modell</label>
                        <select name="mlx_model">
                            {% for key, name in mlx_models.items() %}
                            <option value="{{ key }}" {% if selected_mlx_model == key %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="slider-row">
                        <label>Speed</label>
                        <input type="range" name="speed" min="0.5" max="2" step="0.1" value="{{ speed or 1.0 }}" oninput="updateSlider(this)">
                        <span id="speed-val">{{ speed or 1.0 }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fish Params -->
        <div class="params" id="fish-params">
            <h4>Fish Speech Parameter</h4>
            <div class="slider-row">
                <label>Temperature</label>
                <input type="range" name="fish_temp" min="0.1" max="1.5" step="0.1" value="0.7" oninput="updateSlider(this)">
                <span id="fish_temp-val">0.7</span>
            </div>
        </div>
        
        <button type="submit" id="submitBtn">Generieren</button>
    </form>
    
    {% if audio %}
    <div class="audio-box">
        <h3>Generiertes Audio</h3>
        <audio controls autoplay>
            <source src="data:audio/wav;base64,{{ audio }}" type="audio/wav">
        </audio>
    </div>
    {% endif %}
    
    <script>
        const presets = {{ presets | tojson | safe }};
        
        function selectEngine(engine) {
            document.querySelectorAll('.engine-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-engine="${engine}"]`).classList.add('active');
            document.getElementById('engineInput').value = engine;
            
            // Show/hide params
            document.querySelectorAll('.params').forEach(p => p.classList.remove('visible'));
            const params = document.getElementById(engine + '-params');
            if (params) params.classList.add('visible');
            
            // Filter voices
            filterVoices(engine);
        }
        
        function filterVoices(engine) {
            const select = document.getElementById('voiceSelect');
            const groups = select.querySelectorAll('optgroup');
            groups.forEach(g => {
                g.style.display = g.dataset.engine === engine ? '' : 'none';
            });
            // Select first visible option
            const visibleGroup = select.querySelector(`optgroup[data-engine="${engine}"]`);
            if (visibleGroup && visibleGroup.querySelector('option')) {
                visibleGroup.querySelector('option').selected = true;
            }
        }
        
        function applyPreset() {
            const preset = document.getElementById('presetSelect').value;
            if (preset !== 'custom' && presets[preset]) {
                document.getElementById('exaggeration').value = presets[preset].exaggeration;
                document.getElementById('cfg_weight').value = presets[preset].cfg_weight;
                document.getElementById('temperature').value = presets[preset].temperature;
                updateSlider(document.getElementById('exaggeration'));
                updateSlider(document.getElementById('cfg_weight'));
                updateSlider(document.getElementById('temperature'));
            }
        }
        
        function updateSlider(el) {
            const span = document.getElementById(el.name + '-val');
            if (span) span.textContent = el.value;
        }
        
        // Check server status
        async function checkStatus() {
            try {
                const r = await fetch('/api/health');
                const data = await r.json();
                for (const [engine, status] of Object.entries(data)) {
                    const dot = document.getElementById('status-' + engine);
                    if (dot) {
                        dot.classList.remove('online', 'offline');
                        dot.classList.add(status.status === 'ok' ? 'online' : 'offline');
                    }
                }
            } catch (e) {}
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const engine = document.getElementById('engineInput').value;
            selectEngine(engine);
            checkStatus();
            setInterval(checkStatus, 30000);
        });
    </script>
</body>
</html>
