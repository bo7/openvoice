<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clone Voice - OpenVoice Hub</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: #eee; }
        h1, h2 { color: #00d4ff; }
        a { color: #00d4ff; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 15px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: #252540; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .tab:hover { border-color: #00d4ff; }
        .tab.active { border-color: #00d4ff; background: rgba(0,212,255,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .tip { background: rgba(0,212,255,0.1); border-left: 3px solid #00d4ff; padding: 15px; margin: 20px 0; }
        .tip h4 { margin: 0 0 10px 0; color: #00d4ff; }
        .tip ul { margin: 0; padding-left: 20px; color: #aaa; }
        .tip li { margin: 5px 0; }
        
        .form-section { background: #252540; padding: 25px; border-radius: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; }
        input[type="text"], select { width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #1a1a2e; color: #eee; font-size: 16px; }
        
        .file-upload { border: 2px dashed #333; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a2e; }
        .file-upload:hover { border-color: #00d4ff; }
        .file-upload.dragover { border-color: #00d4ff; background: rgba(0,212,255,0.1); }
        .file-upload input { display: none; }
        .file-upload .icon { font-size: 3em; margin-bottom: 10px; }
        .file-upload .text { color: #888; }
        .file-upload .filename { color: #00d4ff; margin-top: 10px; font-weight: bold; }
        
        .record-section { text-align: center; padding: 30px; }
        .record-btn { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #333; background: #252540; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .record-btn:hover { border-color: #ff4444; }
        .record-btn.recording { border-color: #ff4444; background: rgba(255,68,68,0.2); animation: pulse 1s infinite; }
        .record-btn .icon { font-size: 3em; }
        .record-btn.recording .icon { color: #ff4444; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .record-status { margin-top: 20px; font-size: 1.2em; }
        .record-status .time { color: #00d4ff; font-family: monospace; font-size: 1.5em; }
        .record-status .hint { color: #888; font-size: 0.9em; margin-top: 10px; }
        
        .audio-preview { margin-top: 20px; }
        .audio-preview audio { width: 100%; }
        .audio-preview .controls { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
        .audio-preview button { padding: 8px 16px; border: 1px solid #333; background: #252540; color: #eee; border-radius: 6px; cursor: pointer; }
        .audio-preview button:hover { border-color: #00d4ff; }
        .audio-preview button.danger { border-color: #ff4444; color: #ff4444; }
        .audio-preview button.danger:hover { background: rgba(255,68,68,0.2); }
        
        .waveform { height: 60px; background: #1a1a2e; border-radius: 8px; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 2px; }
        .waveform .bar { width: 4px; background: #00d4ff; border-radius: 2px; transition: height 0.1s; }
        
        .engine-select { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
        .engine-option { padding: 15px; border: 2px solid #333; background: #1a1a2e; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .engine-option:hover { border-color: #00d4ff; }
        .engine-option.active { border-color: #00d4ff; background: rgba(0,212,255,0.1); }
        .engine-option.disabled { opacity: 0.5; cursor: not-allowed; }
        .engine-option .name { font-weight: bold; display: block; margin-bottom: 5px; }
        .engine-option .desc { font-size: 0.8em; color: #888; }
        .engine-option input { display: none; }
        
        button[type="submit"], .submit-btn { background: #00d4ff; color: #1a1a2e; border: none; padding: 15px 40px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; }
        button[type="submit"]:hover, .submit-btn:hover { background: #00b8e6; }
        button[type="submit"]:disabled, .submit-btn:disabled { background: #555; cursor: not-allowed; }
        
        .error { background: #ff4444; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .success { background: #44ff44; color: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        .existing-voices { margin-top: 40px; }
        .voices-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .voice-card { background: #252540; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .voice-card .name { font-weight: bold; color: #00d4ff; }
        .voice-card .engine { font-size: 0.8em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">Home</a>
        <a href="/talk">Speak</a>
        <a href="/compare">Compare</a>
        <a href="/clone">Clone Voice</a>
    </div>
    
    <h1>Clone Voice</h1>
    
    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}
    
    {% if success %}
    <div class="success">{{ success }}</div>
    {% endif %}
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('record')">Record Voice</div>
        <div class="tab" onclick="switchTab('upload')">Upload File</div>
    </div>
    
    <div class="tip">
        <h4>Tips for best voice cloning</h4>
        <ul>
            <li>Record 10-30 seconds of clear speech</li>
            <li>Speak naturally with varied intonation</li>
            <li>Avoid background noise</li>
            <li>Use a good microphone if possible</li>
        </ul>
    </div>
    
    <!-- Record Tab -->
    <div id="tab-record" class="tab-content active">
        <div class="form-section">
            <div class="form-group">
                <label>Voice Name</label>
                <input type="text" id="record-name" placeholder="e.g., my_voice" required>
            </div>
            
            <div class="form-group">
                <label>Target Engine(s)</label>
                <div class="engine-select">
                    <label class="engine-option active" data-engine="all">
                        <input type="radio" name="record-engine" value="all" checked>
                        <span class="name">All Engines</span>
                        <span class="desc">Clone to XTTS, Chatterbox, OpenAudio</span>
                    </label>
                    <label class="engine-option" data-engine="xtts">
                        <input type="radio" name="record-engine" value="xtts">
                        <span class="name">XTTS v2</span>
                        <span class="desc">16 languages</span>
                    </label>
                    <label class="engine-option" data-engine="chatterbox">
                        <input type="radio" name="record-engine" value="chatterbox">
                        <span class="name">Chatterbox</span>
                        <span class="desc">Expressive</span>
                    </label>
                    <label class="engine-option" data-engine="openaudio">
                        <input type="radio" name="record-engine" value="openaudio">
                        <span class="name">OpenAudio</span>
                        <span class="desc">Best quality</span>
                    </label>
                </div>
            </div>
            
            <div class="record-section">
                <button type="button" class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <span class="icon" id="recordIcon">&#9679;</span>
                </button>
                <div class="record-status">
                    <div id="recordStatus">Click to start recording</div>
                    <div class="time" id="recordTime" style="display: none;">00:00</div>
                    <div class="hint" id="recordHint">Recommended: 10-30 seconds</div>
                </div>
                <div class="waveform" id="waveform" style="display: none;"></div>
            </div>
            
            <div class="audio-preview" id="audioPreview" style="display: none;">
                <audio id="recordedAudio" controls></audio>
                <div class="controls">
                    <button type="button" onclick="playRecording()">Play</button>
                    <button type="button" class="danger" onclick="deleteRecording()">Delete & Re-record</button>
                </div>
            </div>
            
            <button type="button" class="submit-btn" id="submitRecordBtn" onclick="submitRecording()" disabled>
                Clone Voice
            </button>
        </div>
    </div>
    
    <!-- Upload Tab -->
    <div id="tab-upload" class="tab-content">
        <form method="POST" enctype="multipart/form-data" class="form-section">
            <div class="form-group">
                <label>Voice Name</label>
                <input type="text" name="name" placeholder="e.g., my_voice" required>
            </div>
            
            <div class="form-group">
                <label>Target Engine</label>
                <div class="engine-select">
                    {% for engine, srv in servers.items() %}
                    {% if srv.supports_cloning %}
                    <label class="engine-option {% if engine == 'xtts' %}active{% endif %}" data-engine="{{ engine }}">
                        <input type="radio" name="engine" value="{{ engine }}" {% if engine == 'xtts' %}checked{% endif %}>
                        <span class="name">{{ srv.name }}</span>
                        <span class="desc">{{ srv.desc }}</span>
                    </label>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label>Audio File</label>
                <div class="file-upload" id="fileUpload">
                    <input type="file" name="audio" id="audioFile" accept="audio/*" required>
                    <div class="icon">&#127908;</div>
                    <div class="text">Drop audio file here or click to browse</div>
                    <div class="filename" id="fileName"></div>
                </div>
            </div>
            
            <button type="submit">Clone Voice</button>
        </form>
    </div>
    
    <div class="existing-voices">
        <h2>Existing Voices</h2>
        <div class="voices-grid">
            {% for engine, voice_list in voices.items() %}
                {% for voice in voice_list %}
                <div class="voice-card">
                    <div class="name">{{ voice }}</div>
                    <div class="engine">{{ engine }}</div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
    
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob;
        let isRecording = false;
        let recordingStartTime;
        let timerInterval;
        let audioContext;
        let analyser;
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        
        // Engine selection
        document.querySelectorAll('.engine-option').forEach(option => {
            option.addEventListener('click', function() {
                const parent = this.closest('.engine-select');
                parent.querySelectorAll('.engine-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                this.querySelector('input').checked = true;
            });
        });
        
        // File upload
        const fileUpload = document.getElementById('fileUpload');
        const audioFile = document.getElementById('audioFile');
        const fileName = document.getElementById('fileName');
        
        fileUpload.addEventListener('click', () => audioFile.click());
        fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); fileUpload.classList.add('dragover'); });
        fileUpload.addEventListener('dragleave', () => fileUpload.classList.remove('dragover'));
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                audioFile.files = e.dataTransfer.files;
                fileName.textContent = e.dataTransfer.files[0].name;
            }
        });
        audioFile.addEventListener('change', () => {
            if (audioFile.files.length) fileName.textContent = audioFile.files[0].name;
        });
        
        // Recording functions
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const url = URL.createObjectURL(recordedBlob);
                    document.getElementById('recordedAudio').src = url;
                    document.getElementById('audioPreview').style.display = 'block';
                    document.getElementById('submitRecordBtn').disabled = false;
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordStatus').textContent = 'Recording...';
                document.getElementById('recordTime').style.display = 'block';
                document.getElementById('recordHint').textContent = 'Click to stop';
                document.getElementById('waveform').style.display = 'flex';
                
                startTimer();
                visualize();
                
            } catch (err) {
                alert('Microphone access denied. Please allow microphone access.');
                console.error(err);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(timerInterval);
                
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordStatus').textContent = 'Recording complete';
                document.getElementById('recordHint').textContent = 'Review your recording below';
                document.getElementById('waveform').style.display = 'none';
            }
        }
        
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordTime').textContent = `${mins}:${secs}`;
            }, 1000);
        }
        
        function visualize() {
            const waveform = document.getElementById('waveform');
            waveform.innerHTML = '';
            const barCount = 32;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = '4px';
                waveform.appendChild(bar);
            }
            
            const bars = waveform.querySelectorAll('.bar');
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function draw() {
                if (!isRecording) return;
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                for (let i = 0; i < barCount; i++) {
                    const index = Math.floor(i * dataArray.length / barCount);
                    const value = dataArray[index];
                    const height = Math.max(4, (value / 255) * 50);
                    bars[i].style.height = `${height}px`;
                }
            }
            draw();
        }
        
        function playRecording() {
            document.getElementById('recordedAudio').play();
        }
        
        function deleteRecording() {
            recordedBlob = null;
            audioChunks = [];
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('submitRecordBtn').disabled = true;
            document.getElementById('recordStatus').textContent = 'Click to start recording';
            document.getElementById('recordTime').style.display = 'none';
            document.getElementById('recordTime').textContent = '00:00';
            document.getElementById('recordHint').textContent = 'Recommended: 10-30 seconds';
        }
        
        async function submitRecording() {
            const name = document.getElementById('record-name').value.trim();
            if (!name) {
                alert('Please enter a voice name');
                return;
            }
            if (!recordedBlob) {
                alert('Please record audio first');
                return;
            }
            
            const engine = document.querySelector('input[name="record-engine"]:checked').value;
            
            const formData = new FormData();
            formData.append('name', name);
            formData.append('audio', recordedBlob, `${name}.wav`);
            formData.append('engine', engine);
            formData.append('from_recording', 'true');
            
            document.getElementById('submitRecordBtn').disabled = true;
            document.getElementById('submitRecordBtn').textContent = 'Cloning...';
            
            try {
                const response = await fetch('/clone', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    const text = await response.text();
                    alert('Cloning failed: ' + text);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                document.getElementById('submitRecordBtn').disabled = false;
                document.getElementById('submitRecordBtn').textContent = 'Clone Voice';
            }
        }
    </script>
</body>
</html>
